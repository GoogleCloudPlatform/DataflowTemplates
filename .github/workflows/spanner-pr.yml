# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Checks that are intended to run on PRs containing Java code.

name: Spanner PR

on:
  pull_request:
    branches:
    - 'main'
    paths:
      # Template wide common modules
      - 'v2/common/**'
      - 'v2/datastream-common/**'
      - 'it/google-cloud-platform/**'
      - 'it/conditions/**'
      # Component common modules
      - 'v2/spanner-common/**'
      - 'v2/spanner-migrations-sdk/**'
      - 'v2/spanner-custom-shard/**'
      # Include spanner paths
      - '.github/workflows/spanner-pr.yml'
      - 'v2/datastream-to-spanner/**'
      - 'v2/spanner-change-streams-to-sharded-file-sink/**'
      - 'v2/gcs-to-sourcedb/**'
      - 'v2/sourcedb-to-spanner/**'
      - 'v2/spanner-to-sourcedb/**'
  schedule:
  - cron: "3 */12 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

env:
  MAVEN_OPTS: -Dorg.slf4j.simpleLogger.log.org.apache.maven.plugins.shade=error

permissions: read-all

jobs:
  smt_installation:
    name: Install SMT
    needs: [ ]
    timeout-minutes: 60
    runs-on: [ self-hosted, root ]  # Use 'root' runner
    steps:
    - name: Checkout SMT Code
      uses: actions/checkout@v4
      with:
        repository: GoogleCloudPlatform/spanner-migration-tool
        token: ${{ secrets.GITHUB_TOKEN }}
        path: spanner-migration-tool
        fetch-depth: 0
    - name: Setup Environment
      id: setup-env
      uses: ./.github/actions/setup-env
    - name: Set up C++ environment
      uses: actions/setup-cpp@v1
      with:
        gcc: true
    - name: Install Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.19'
    - name: Prepare Go Modules
      run: |
        cd spanner-migration-tool
        go mod tidy
    - name: Build Spanner Migration Tool
      run: |
        cd spanner-migration-tool
        make build
    - name: Add Binary to PATH
      run: echo "$GITHUB_WORKSPACE/spanner-migration-tool" >> $GITHUB_PATH