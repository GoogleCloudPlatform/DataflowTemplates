name: Spanner Terraform Validator

on:
  pull_request:
    branches:
    - main  # Adjust the branch if needed
    paths:
    # Include spanner terraform sample paths only
    - '.github/workflows/spanner-terraform-validator.yml'
    - 'v2/datastream-to-spanner/terraform/samples/**'
    - 'v2/sourcedb-to-spanner/terraform/samples/**'

jobs:
  verify-structure:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Verify Terraform sample structure
      id: find-samples
      run: |
        SAMPLES=$(find v2/datastream-to-spanner/terraform/samples v2/sourcedb-to-spanner/terraform/samples -mindepth 1 -maxdepth 1 -type d)
        echo "Identified sample directories:" $SAMPLES
        FILE_LIST=(main.tf outputs.tf variables.tf terraform.tf terraform.tfvars terraform_simple.tfvars README.md)
        FAILED_SAMPLES=()
        
        for SAMPLE in $SAMPLES; do
          if [[ ! -d "$SAMPLE" ]]; then
          echo "Skipping non-directory: $SAMPLE"
            continue
          fi
        
          echo "Verifying sample: $SAMPLE"
          
          for FILE in $FILE_LIST; do
            if [[ ! -f "$SAMPLE/$FILE" ]]; then
              echo "ERROR: Missing file: $SAMPLE/$FILE"
              FAILED_SAMPLES+=("$SAMPLE")
              break
            fi
          done
          
          if [[ ! " ${FAILED_SAMPLES[*]} " =~ " ${SAMPLE} " ]]; then # Check if sample is in failed list
            echo "Verified sample successfully: $SAMPLE"
          fi
        done  
        echo "Verification completed!"
        if [[ ${#FAILED_SAMPLES[@]} -gt 0 ]]; then
          echo "The following samples failed validation:"
          for SAMPLE in "${FAILED_SAMPLES[@]}"; do
            echo "- $SAMPLE"
          done
          exit 1  # Indicate failure if there were any failed samples
        fi
        echo "All samples validated successfully!"

    - name: Verify Datastream-to-spanner Terraform formatting
      uses: dflook/terraform-fmt-check@v1
      with:
          path: v2/datastream-to-spanner/terraform/samples